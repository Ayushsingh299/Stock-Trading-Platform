import java.io.*;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.*;
class Stock implements Serializable {
    String symbol;
    String name;
    double price;    // current price
    double volatility; // rough volatility factor (0.01 = 1%)

    public Stock(String symbol, String name, double price, double volatility) {
        this.symbol = symbol.toUpperCase();
        this.name = name;
        this.price = price;
        this.volatility = volatility;
    }

    @Override
    public String toString() {
        return String.format("%s (%s): ₹%.2f  vol=%.2f%%", symbol, name, price, volatility * 100);
    }
}

class Transaction implements Serializable {
    enum Type { BUY, SELL }
    String id;
    Type type;
    String symbol;
    int quantity;
    double pricePerShare;
    double total;
    LocalDateTime timestamp;

    public Transaction(Type type, String symbol, int quantity, double pricePerShare) {
        this.id = UUID.randomUUID().toString();
        this.type = type;
        this.symbol = symbol.toUpperCase();
        this.quantity = quantity;
        this.pricePerShare = pricePerShare;
        this.total = pricePerShare * quantity;
        this.timestamp = LocalDateTime.now();
    }

    @Override
    public String toString() {
        return String.format("[%s] %s %d x %s @ ₹%.2f = ₹%.2f  (%s)",
                id.substring(0,8), type, quantity, symbol, pricePerShare, total,
                timestamp.format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
    }
}

class Portfolio implements Serializable {
    // symbol -> shares owned
    Map<String, Integer> holdings = new HashMap<>();
    double cash; // available cash
    List<Transaction> history = new ArrayList<>();

    public Portfolio(double startingCash) {
        this.cash = startingCash;
    }

    public int sharesOf(String symbol) {
        return holdings.getOrDefault(symbol.toUpperCase(), 0);
    }

    public void addShares(String symbol, int qty) {
        symbol = symbol.toUpperCase();
        holdings.put(symbol, sharesOf(symbol) + qty);
    }

    public void removeShares(String symbol, int qty) {
        symbol = symbol.toUpperCase();
        int current = sharesOf(symbol);
        int after = Math.max(0, current - qty);
        if (after == 0) holdings.remove(symbol);
        else holdings.put(symbol, after);
    }

    public void addCash(double amount) { cash += amount; }
    public void deductCash(double amount) { cash -= amount; }

    public double portfolioValue(Market market) {
        double value = cash;
        for (Map.Entry<String, Integer> e : holdings.entrySet()) {
            Stock s = market.getStock(e.getKey());
            if (s != null) value += s.price * e.getValue();
        }
        return value;
    }
}

/* --------------------------
   Market simulation
   -------------------------- */

class Market implements Serializable {
    Map<String, Stock> universe = new HashMap<>();
    Random rnd = new Random();
    LocalDateTime lastTick = LocalDateTime.now();

    public Market() {}

    public void addStock(Stock s) { universe.put(s.symbol, s); }

    public Stock getStock(String symbol) { return universe.get(symbol.toUpperCase()); }

    public Collection<Stock> allStocks() { return universe.values(); }

    // Single tick: simple geometric random walk step (no background thread)
    public void tick() {
        for (Stock s : universe.values()) {
            // percentage change: normal approx using volatility
            double pct = (rnd.nextGaussian()) * s.volatility;
            double factor = Math.exp(pct); // multiplicative
            double newPrice = s.price * factor;

            // floor price to small min to avoid zero/negative
            if (newPrice < 0.01) newPrice = 0.01;
            s.price = Math.round(newPrice * 100.0) / 100.0; // 2 decimals
        }
        lastTick = LocalDateTime.now();
    }

    public void printSnapshot() {
        System.out.println("Market snapshot at " + lastTick.format(DateTimeFormatter.ofPattern("yyyy-MM-dd HH:mm:ss")));
        System.out.println("Symbol   Price    Name");
        for (Stock s : universe.values()) {
            System.out.printf("%-7s ₹%7.2f   %s%n", s.symbol, s.price, s.name);
        }
    }
}

/* --------------------------
   User & Storage
   -------------------------- */

class User implements Serializable {
    String username;
    Portfolio portfolio;

    public User(String username, double initialCash) {
        this.username = username;
        this.portfolio = new Portfolio(initialCash);
    }
}

class Storage {
    private static final String FILE = "users.dat";

    public static Map<String, User> loadAllUsers() {
        File f = new File(FILE);
        if (!f.exists()) return new HashMap<>();
        try (ObjectInputStream ois = new ObjectInputStream(new FileInputStream(f))) {
            Object o = ois.readObject();
            if (o instanceof Map) return (Map<String, User>) o;
            else return new HashMap<>();
        } catch (Exception e) {
            System.out.println("Could not load users: " + e.getMessage());
            return new HashMap<>();
        }
    }

    public static void saveAllUsers(Map<String, User> users) {
        try (ObjectOutputStream oos = new ObjectOutputStream(new FileOutputStream(FILE))) {
            oos.writeObject(users);
        } catch (Exception e) {
            System.out.println("Could not save users: " + e.getMessage());
        }
    }
}

/* --------------------------
   Main console application
   -------------------------- */

class StockTradingSystem {
    static Scanner sc = new Scanner(System.in);
    static Market market = new Market();
    static Map<String, User> users = Storage.loadAllUsers();
    static User currentUser = null;

    public static void main(String[] args) {
        seedMarket();
        System.out.println("Welcome to SimpleStock — a basic stock trading simulator.");
        while (true) {
            if (currentUser == null) showAuthMenu();
            else showMainMenu();
        }
    }

    static void seedMarket() {
        // Add some stocks (symbol, name, price, volatility)
        market.addStock(new Stock("TCS", "Tata Consultancy Services", 3500.00, 0.008));
        market.addStock(new Stock("INFY", "Infosys Ltd", 1600.00, 0.01));
        market.addStock(new Stock("RELI", "Reliance Industries", 2550.00, 0.012));
        market.addStock(new Stock("HDFC", "HDFC Bank", 1500.00, 0.009));
        market.addStock(new Stock("LT", "Larsen & Toubro", 2600.00, 0.013));
        market.addStock(new Stock("RELIETF", "Reliance ETF (demo)", 100.00, 0.02));
    }

    static void showAuthMenu() {
        System.out.println("\n--- Authentication ---");
        System.out.println("1) Login");
        System.out.println("2) Register");
        System.out.println("3) List users");
        System.out.println("4) Quit");
        System.out.print("Choice: ");
        String c = sc.nextLine().trim();
        switch (c) {
            case "1": login(); break;
            case "2": register(); break;
            case "3": listUsers(); break;
            case "4": exit(); break;
            default: System.out.println("Invalid."); break;
        }
    }

    static void login() {
        System.out.print("Username: ");
        String u = sc.nextLine().trim();
        if (!users.containsKey(u)) { System.out.println("User not found."); return; }
        currentUser = users.get(u);
        System.out.println("Logged in as " + currentUser.username + ". Cash: ₹" + currentUser.portfolio.cash);
    }

    static void register() {
        System.out.print("Choose username: ");
        String u = sc.nextLine().trim();
        if (u.isEmpty() || users.containsKey(u)) { System.out.println("Invalid or already exists."); return; }
        System.out.print("Starting cash (e.g. 100000): ");
        double cash = 100000;
        try { cash = Double.parseDouble(sc.nextLine().trim()); } catch (Exception ignored) {}
        User user = new User(u, cash);
        users.put(u, user);
        Storage.saveAllUsers(users);
        System.out.println("Registered. You may login now.");
    }

    static void listUsers() {
        System.out.println("Known users:");
        for (String k : users.keySet()) System.out.println(" - " + k);
    }

    static void exit() {
        System.out.println("Bye.");
        Storage.saveAllUsers(users);
        System.exit(0);
    }

    static void showMainMenu() {
        System.out.println("\n--- Main Menu (user: " + currentUser.username + ") ---");
        System.out.println("1) Show market snapshot");
        System.out.println("2) Advance market (tick)");
        System.out.println("3) Buy stock");
        System.out.println("4) Sell stock");
        System.out.println("5) View portfolio");
        System.out.println("6) Transaction history");
        System.out.println("7) Save / Persist");
        System.out.println("8) Logout");
        System.out.print("Choice: ");
        String c = sc.nextLine().trim();
        switch (c) {
            case "1": market.printSnapshot(); printPortfolioSummary(); break;
            case "2": market.tick(); System.out.println("Market advanced."); printPortfolioSummary(); break;
            case "3": buyFlow(); break;
            case "4": sellFlow(); break;
            case "5": showPortfolioDetails(); break;
            case "6": printTransactions(); break;
            case "7": persist(); break;
            case "8": logout(); break;
            default: System.out.println("Invalid."); break;
        }
    }

    static void printPortfolioSummary() {
        double pv = currentUser.portfolio.portfolioValue(market);
        System.out.printf("Portfolio Value: ₹%.2f (Cash: ₹%.2f)%n", pv, currentUser.portfolio.cash);
    }

    static void buyFlow() {
        System.out.print("Enter symbol to BUY: ");
        String sym = sc.nextLine().trim().toUpperCase();
        Stock s = market.getStock(sym);
        if (s == null) { System.out.println("Symbol not found."); return; }
        System.out.println("Price: ₹" + s.price);
        System.out.print("Quantity: ");
        int qty;
        try { qty = Integer.parseInt(sc.nextLine().trim()); } catch (Exception e) { System.out.println("Invalid qty."); return; }
        double cost = qty * s.price;
        if (cost > currentUser.portfolio.cash) { System.out.println("Insufficient cash."); return; }
        // execute
        currentUser.portfolio.deductCash(cost);
        currentUser.portfolio.addShares(sym, qty);
        Transaction t = new Transaction(Transaction.Type.BUY, sym, qty, s.price);
        currentUser.portfolio.history.add(t);
        System.out.println("Bought: " + t);
    }

    static void sellFlow() {
        System.out.print("Enter symbol to SELL: ");
        String sym = sc.nextLine().trim().toUpperCase();
        Stock s = market.getStock(sym);
        if (s == null) { System.out.println("Symbol not found."); return; }
        int owned = currentUser.portfolio.sharesOf(sym);
        System.out.println("You own: " + owned + " shares.");
        if (owned == 0) { System.out.println("No shares to sell."); return; }
        System.out.print("Quantity to sell: ");
        int qty;
        try { qty = Integer.parseInt(sc.nextLine().trim()); } catch (Exception e) { System.out.println("Invalid qty."); return; }
        if (qty <= 0 || qty > owned) { System.out.println("Quantity invalid."); return; }
        double proceeds = qty * s.price;
        currentUser.portfolio.addCash(proceeds);
        currentUser.portfolio.removeShares(sym, qty);
        Transaction t = new Transaction(Transaction.Type.SELL, sym, qty, s.price);
        currentUser.portfolio.history.add(t);
        System.out.println("Sold: " + t);
    }

    static void showPortfolioDetails() {
        System.out.println("\n--- Portfolio Details ---");
        System.out.printf("Cash: ₹%.2f%n", currentUser.portfolio.cash);
        System.out.println("Holdings:");
        if (currentUser.portfolio.holdings.isEmpty()) System.out.println(" (none)");
        else {
            System.out.printf("%-8s %8s %12s %12s%n", "Symbol", "Shares", "Price", "Value");
            for (Map.Entry<String, Integer> e : currentUser.portfolio.holdings.entrySet()) {
                Stock s = market.getStock(e.getKey());
                double price = (s != null) ? s.price : 0.0;
                double val = price * e.getValue();
                System.out.printf("%-8s %8d %12.2f %12.2f%n", e.getKey(), e.getValue(), price, val);
            }
        }
        System.out.printf("Total portfolio value: ₹%.2f%n", currentUser.portfolio.portfolioValue(market));
    }

    static void printTransactions() {
        System.out.println("\n--- Transaction History ---");
        if (currentUser.portfolio.history.isEmpty()) System.out.println("(none)");
        else {
            for (Transaction t : currentUser.portfolio.history) System.out.println(t);
        }
    }

    static void persist() {
        users.put(currentUser.username, currentUser); // refresh in map
        Storage.saveAllUsers(users);
        System.out.println("Saved.");
    }

    static void logout() {
        persist();
        currentUser = null;
        System.out.println("Logged out.");
    }
}
